version: 1
default_environment: dev
send_anonymous_usage_stats: false
project_id: 33080f0b-2d0f-4fba-b7f1-727bbf080f91

plugins:
  extractors:
  - name: tap-csv
    variant: meltanolabs
    pip_url: git+https://github.com/MeltanoLabs/tap-csv.git
  - name: tap-smoke-test
    namespace: tap_smoke_test
    pip_url: git+https://github.com/meltano/tap-smoke-test.git
    executable: tap-smoke-test
    capabilities:
    - discover
    - catalog
    settings:
    - name: schema_inference_record_count
      kind: integer
    - name: streams
      kind: array
  - name: people
    namespace: people
    executable: scripts/people.sh
  - name: nested
    namespace: nested
    executable: scripts/nested.sh
  loaders:
  - name: target-sqlite
    variant: meltanolabs
    pip_url: git+https://github.com/MeltanoLabs/target-sqlite.git
    config:
      batch_size: 200
      database: output/$MELTANO_EXTRACTOR_NAMESPACE.db
  mappers:
  - name: meltano-map-transformer
    namespace: meltano_map_transformer
    pip_url: -e .
    executable: meltano-map-transform
    settings:
    - name: stream_maps
      kind: object
    mappings:
    - name: hash_email
      config:
        stream_maps:
          customers:
            id: id
            email:      # drop the PII field from RECORD and SCHEMA messages
            email_domain: email.split('@')[-1]
            email_hash: md5(config['hash_seed'] + email)
            # is_gmail: "'@gmail.com' in email"
            # is_yahoo: "'@yahoo.' in email"
            __else__: null
            # __schema__:
            #   is_gmail:
            #     type: boolean
            #   is_yahoo:
            #     type: boolean
        stream_map_config:
          hash_seed: 01AWZh7A6DzGm6iJZZ2T
    - name: allowlist-fields
      config:
        stream_maps:
          # Allow `id` and `description` fields, drop all others
          animals:
            id: id
            description: description
            __else__: __NULL__
    - name: flatten-fields
      config:
        stream_maps: {}
        flattening_enabled: true
        flattening_max_depth: 1
    - name: list-comprehension
      config:
        stream_maps:
          users:
            id: id
            fields: "[f for f in fields if f['key'] != 'age']"
environments:
- name: dev
  config:
    plugins:
      extractors:
      - name: tap-csv
        config:
          files:
          - entity: customers
            path: fixtures/customers.csv
            keys: [id]
      - name: tap-smoke-test
        config:
          schema_inference_record_count: 5
          streams:
          - stream_name: animals
            input_filename: fixtures/animals-data.jsonl
jobs:
- name: hash-email
  tasks: [tap-csv, hash_email, target-sqlite]
- name: allowlist
  tasks: [tap-smoke-test, allowlist-fields, target-sqlite]
- name: flatten
  tasks: [people, flatten-fields, target-sqlite]
- name: comprehension
  tasks: [nested, list-comprehension, target-sqlite]
schedules:
- name: hash-email
  job: hash-email
  interval: "@daily"
- name: allowlist
  job: allowlist
  interval: "@daily"
- name: flatten
  job: flatten
  interval: "@daily"
- name: comprehension
  job: comprehension
  interval: "@daily"
